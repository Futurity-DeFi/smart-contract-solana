# .github/workflows/verifiable-build.yml
#
# Builds a deterministic artefact with Anchor v0.31.1,
# then (optionally) deploys & verifies it.
# Anchor CLI comes from the pre-built binary → ~15 s.

name: Verifiable Build & Deploy

on:
  workflow_dispatch:
  push:
    branches: [main]

env:
  ANCHOR_VERSION: v0.31.1
  DOCKER_DEFAULT_PLATFORM: linux/amd64
  CARGO_INCREMENTAL: "0"
  PROGRAM_PUBKEY: 2PswCESR7U3MF9CL3B89qQFnJ9tac6ucGVQR3Zm7xeGP
  SOLANA_CLUSTER_URL: https://api.devnet.solana.com   # change for mainnet

jobs:

# ───────────────────────────── 1) BUILD ─────────────────────────────
  build:
    runs-on: ubuntu-latest

    steps:
    - name: 🛎️  Checkout
      uses: actions/checkout@v4
      with: { fetch-depth: 1 }

    - name: 💾 Cache cargo deps
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
        key: cargo-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

    - name: ⚡ Install Anchor CLI (pre-built)
      run: |
        curl -sSfL \
          "https://github.com/coral-xyz/anchor/releases/download/${A
